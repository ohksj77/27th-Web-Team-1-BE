name: CD - Deploy to EC2

on:
    workflow_run:
        workflows: [ "CI - Build and Test" ]
        types:
            - completed

env:
    AWS_REGION: ap-northeast-2
    CONTAINER_NAME: dev-lokit-api

jobs:
    deploy:
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'develop' }}

        steps:
            -   name: Configure AWS credentials
                uses: aws-actions/configure-aws-credentials@v4
                with:
                    aws-access-key-id: ${{ secrets.DEV_AWS_ACCESS_KEY_ID }}
                    aws-secret-access-key: ${{ secrets.DEV_AWS_SECRET_ACCESS_KEY }}
                    aws-region: ${{ env.AWS_REGION }}

            -   name: Get Runner IP
                id: ip
                run: echo "runner_ip=$(curl -s https://checkip.amazonaws.com)" >> $GITHUB_OUTPUT

            -   name: Add Runner IP to Security Group
                run: |
                    aws ec2 authorize-security-group-ingress \
                        --group-id ${{ secrets.DEV_SECURITY_GROUP_ID }} \
                        --protocol tcp \
                        --port 22 \
                        --cidr ${{ steps.ip.outputs.runner_ip }}/32 \
                        --region ${{ env.AWS_REGION }}

            -   name: Login to Amazon ECR
                id: login-ecr
                uses: aws-actions/amazon-ecr-login@v2

            -   name: Deploy to EC2
                uses: appleboy/ssh-action@master
                env:
                    ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
                    ECR_REPOSITORY: ${{ secrets.DEV_ECR_REPOSITORY }}
                    CONTAINER_NAME: ${{ env.CONTAINER_NAME }}
                    AWS_REGION: ${{ env.AWS_REGION }}
                with:
                    host: ${{ secrets.DEV_EC2_HOST }}
                    username: ${{ secrets.DEV_EC2_USERNAME }}
                    key: ${{ secrets.DEV_EC2_SSH_KEY }}
                    envs: ECR_REGISTRY,ECR_REPOSITORY,CONTAINER_NAME,AWS_REGION
                    script: |
                        set -e

                        SSM_PREFIX="/lokit/dev"

                        aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY

                        docker pull $ECR_REGISTRY/$ECR_REPOSITORY:dev-latest

                        docker stop $CONTAINER_NAME 2>/dev/null || true
                        docker rm $CONTAINER_NAME 2>/dev/null || true

                        ENV_ARGS=""
                        while IFS= read -r line; do
                            key=$(echo "$line" | jq -r '.Name' | sed "s|${SSM_PREFIX}/||")
                            value=$(echo "$line" | jq -r '.Value')
                            ENV_ARGS="$ENV_ARGS -e $key=$value"
                        done < <(aws ssm get-parameters-by-path \
                            --path "$SSM_PREFIX" \
                            --with-decryption \
                            --region $AWS_REGION \
                            --query "Parameters[]" \
                            --output json | jq -c '.[]')

                        docker run -d \
                            --name $CONTAINER_NAME \
                            --restart unless-stopped \
                            -p 8080:8080 \
                            -e SPRING_PROFILES_ACTIVE=dev \
                            -e TZ=Asia/Seoul \
                            -e AWS_REGION=$AWS_REGION \
                            $ENV_ARGS \
                            --log-driver=awslogs \
                            --log-opt awslogs-region=$AWS_REGION \
                            --log-opt awslogs-group=/docker/lokit-api-dev \
                            --log-opt awslogs-stream=$CONTAINER_NAME-$(date +%Y%m%d-%H%M%S) \
                            --log-opt awslogs-create-group=true \
                            --memory="700m" \
                            --memory-swap="1400m" \
                            --cpus="1.5" \
                            $ECR_REGISTRY/$ECR_REPOSITORY:dev-latest

                        docker ps --filter "name=$CONTAINER_NAME" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

                        docker logs $CONTAINER_NAME --tail 30

                        docker image prune -af --filter "until=24h"

            -   name: Remove Runner IP from Security Group
                if: always()
                run: |
                    aws ec2 revoke-security-group-ingress \
                        --group-id ${{ secrets.DEV_SECURITY_GROUP_ID }} \
                        --protocol tcp \
                        --port 22 \
                        --cidr ${{ steps.ip.outputs.runner_ip }}/32 \
                        --region ${{ env.AWS_REGION }} || true
