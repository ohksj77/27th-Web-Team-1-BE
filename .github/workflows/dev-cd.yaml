name: CD - Deploy to EC2

on:
    workflow_run:
        workflows: [ "CI - Build and Test" ]
        types:
            - completed

env:
    AWS_REGION: ap-northeast-2
    CONTAINER_NAME: dev-lokit-api

jobs:
    deploy:
        runs-on: ubuntu-latest
        if: ${{ github.event.workflow_run.conclusion == 'success' }}

        steps:
            -   name: Configure AWS credentials
                uses: aws-actions/configure-aws-credentials@v4
                with:
                    aws-access-key-id: ${{ secrets.DEV_AWS_ACCESS_KEY_ID }}
                    aws-secret-access-key: ${{ secrets.DEV_AWS_SECRET_ACCESS_KEY }}
                    aws-region: ${{ env.AWS_REGION }}

            -   name: Get Runner IP
                id: ip
                run: echo "runner_ip=$(curl -s https://checkip.amazonaws.com)" >> $GITHUB_OUTPUT

            -   name: Add Runner IP to Security Group
                run: |
                    aws ec2 authorize-security-group-ingress \
                        --group-id ${{ secrets.DEV_SECURITY_GROUP_ID }} \
                        --protocol tcp \
                        --port 22 \
                        --cidr ${{ steps.ip.outputs.runner_ip }}/32 \
                        --region ${{ env.AWS_REGION }}

            -   name: Login to Amazon ECR
                id: login-ecr
                uses: aws-actions/amazon-ecr-login@v2

            -   name: Deploy to EC2
                uses: appleboy/ssh-action@master
                env:
                    ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
                    ECR_REPOSITORY: ${{ secrets.DEV_ECR_REPOSITORY }}
                    CONTAINER_NAME: ${{ env.CONTAINER_NAME }}
                    AWS_REGION: ${{ env.AWS_REGION }}
                    POSTGRES_HOST: ${{ secrets.DEV_POSTGRES_HOST }}
                    POSTGRES_PORT: ${{ secrets.DEV_POSTGRES_PORT }}
                    POSTGRES_DB: ${{ secrets.DEV_POSTGRES_DB }}
                    POSTGRES_USER: ${{ secrets.DEV_POSTGRES_USER }}
                    POSTGRES_PASSWORD: ${{ secrets.DEV_POSTGRES_PASSWORD }}
                    JWT_SECRET: ${{ secrets.DEV_JWT_SECRET }}
                    JWT_EXPIRATION: ${{ secrets.DEV_JWT_EXPIRATION }}
                    AWS_S3_BUCKET: ${{ secrets.DEV_AWS_S3_BUCKET }}
                    CORS_ALLOWED_ORIGINS: ${{ secrets.DEV_CORS_ALLOWED_ORIGINS }}
                    JWT_REFRESH_EXPIRATION: ${{ secrets.DEV_JWT_REFRESH_EXPIRATION }}
                    KAKAO_API_KEY: ${{ secrets.DEV_KAKAO_API_KEY}}
                with:
                    host: ${{ secrets.DEV_EC2_HOST }}
                    username: ${{ secrets.DEV_EC2_USERNAME }}
                    key: ${{ secrets.DEV_EC2_SSH_KEY }}
                    envs: ECR_REGISTRY,ECR_REPOSITORY,CONTAINER_NAME,AWS_REGION,POSTGRES_HOST,POSTGRES_PORT,POSTGRES_DB,POSTGRES_USER,POSTGRES_PASSWORD,JWT_SECRET,JWT_EXPIRATION,AWS_S3_BUCKET,CORS_ALLOWED_ORIGINS,JWT_REFRESH_EXPIRATION
                    script: |
                        set -e

                        aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY

                        docker pull $ECR_REGISTRY/$ECR_REPOSITORY:dev-latest

                        docker stop $CONTAINER_NAME 2>/dev/null || true
                        docker rm $CONTAINER_NAME 2>/dev/null || true

                        docker run -d \
                            --name $CONTAINER_NAME \
                            --restart unless-stopped \
                            -p 8080:8080 \
                            -e SPRING_PROFILES_ACTIVE=dev \
                            -e POSTGRES_HOST=$POSTGRES_HOST \
                            -e POSTGRES_PORT=$POSTGRES_PORT \
                            -e POSTGRES_DB=$POSTGRES_DB \
                            -e POSTGRES_USER=$POSTGRES_USER \
                            -e POSTGRES_PASSWORD=$POSTGRES_PASSWORD \
                            -e TZ=Asia/Seoul \
                            -e JWT_SECRET=$JWT_SECRET \
                            -e JWT_EXPIRATION=$JWT_EXPIRATION \
                            -e AWS_REGION=$AWS_REGION \
                            -e AWS_S3_BUCKET=$AWS_S3_BUCKET \
                            -e CORS_ALLOWED_ORIGINS=$CORS_ALLOWED_ORIGINS \
                            -e JWT_REFRESH_EXPIRATION=$JWT_REFRESH_EXPIRATION \
                            -e KAKAO_API_KEY=$KAKAO_API_KEY \
                            --log-driver=awslogs \
                            --log-opt awslogs-region=$AWS_REGION \
                            --log-opt awslogs-group=/docker/lokit-api-dev \
                            --log-opt awslogs-stream=$CONTAINER_NAME-$(date +%Y%m%d-%H%M%S) \
                            --log-opt awslogs-create-group=true \
                            --memory="700m" \
                            --memory-swap="1400m" \
                            --cpus="1.5" \
                            $ECR_REGISTRY/$ECR_REPOSITORY:dev-latest

                        timeout=60
                        while [ $timeout -gt 0 ]; do
                            health=$(docker inspect --format='{{.State.Health.Status}}' $CONTAINER_NAME 2>/dev/null || echo "starting")
                            if [ "$health" = "healthy" ]; then
                                echo "Container is healthy!"
                                break
                            fi
                            sleep 2
                            timeout=$((timeout-2))
                        done

                        docker ps --filter "name=$CONTAINER_NAME" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

                        docker logs $CONTAINER_NAME --tail 30

                        docker image prune -af --filter "until=24h"

            -   name: Remove Runner IP from Security Group
                if: always()
                run: |
                    aws ec2 revoke-security-group-ingress \
                        --group-id ${{ secrets.DEV_SECURITY_GROUP_ID }} \
                        --protocol tcp \
                        --port 22 \
                        --cidr ${{ steps.ip.outputs.runner_ip }}/32 \
                        --region ${{ env.AWS_REGION }} || true
