name: CI - Build and Test

on:
    push:
        branches: [ develop ]
        paths:
            - '**.kt'
            - '**/*.kt'
            - 'gradle/**'
            - 'build.gradle.kts'
            - 'settings.gradle.kts'
    pull_request:
        branches: [ develop ]
        paths:
            - '**.kt'
            - '**/*.kt'
            - 'gradle/**'
            - 'build.gradle.kts'
            - 'settings.gradle.kts'
    workflow_dispatch:

env:
    AWS_REGION: ap-northeast-2

jobs:
    build-and-test:
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Set up JDK 24
                uses: actions/setup-java@v4
                with:
                    java-version: '24'
                    distribution: 'temurin'
                    cache: 'gradle'

            -   name: Grant execute permission for gradlew
                run: chmod +x gradlew

            -   name: Cache Gradle packages
                uses: actions/cache@v4
                with:
                    path: |
                        ~/.gradle/caches
                        ~/.gradle/wrapper
                    key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
                    restore-keys: |
                        ${{ runner.os }}-gradle-

            -   name: Build with Gradle
                run: ./gradlew clean build -x test --parallel --build-cache

            -   name: Run tests
                env:
                    SPRING_PROFILES_ACTIVE: test
                run: ./gradlew test --parallel

            -   name: Test Report
                uses: dorny/test-reporter@v1
                if: success() || failure()
                with:
                    name: Test Results
                    path: build/test-results/test/*.xml
                    reporter: java-junit

            -   name: Configure AWS credentials
                uses: aws-actions/configure-aws-credentials@v4
                with:
                    aws-access-key-id: ${{ secrets.DEV_AWS_ACCESS_KEY_ID }}
                    aws-secret-access-key: ${{ secrets.DEV_AWS_SECRET_ACCESS_KEY }}
                    aws-region: ${{ env.AWS_REGION }}

            -   name: Login to Amazon ECR
                id: login-ecr
                uses: aws-actions/amazon-ecr-login@v2

            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v3

            -   name: Build and push Docker image to ECR
                env:
                    ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
                    ECR_REPOSITORY: ${{ secrets.DEV_ECR_REPOSITORY }}
                    IMAGE_TAG: ${{ github.sha }}
                run: |
                    docker buildx build \
                        --platform linux/amd64 \
                        --cache-from type=registry,ref=$ECR_REGISTRY/$ECR_REPOSITORY:buildcache \
                        --cache-to type=registry,ref=$ECR_REGISTRY/$ECR_REPOSITORY:buildcache,mode=max \
                        --tag $ECR_REGISTRY/$ECR_REPOSITORY:latest \
                        --tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
                        --tag $ECR_REGISTRY/$ECR_REPOSITORY:dev-latest \
                        --push \
                        --build-arg BUILDKIT_INLINE_CACHE=1 \
                        .

            -   name: Image digest
                run: echo "Image pushed successfully"
