name: CI - Build and Test

on:
    push:
        branches: [ develop ]
    pull_request:
        branches: [ develop ]
    workflow_dispatch:

env:
    AWS_REGION: ap-northeast-2

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Set up JDK 24 (Gradle cache)
                uses: actions/setup-java@v4
                with:
                    java-version: '24'
                    distribution: 'temurin'
                    cache: gradle

            -   name: Build & Test (single Gradle run)
                env:
                    SPRING_PROFILES_ACTIVE: test
                run: |
                    ./gradlew build \
                        --parallel \
                        --build-cache \
                        --no-daemon

            -   name: Test Report
                uses: dorny/test-reporter@v1
                if: success() || failure()
                with:
                    name: Test Results
                    path: build/test-results/test/*.xml
                    reporter: java-junit

            -   name: Configure AWS credentials
                uses: aws-actions/configure-aws-credentials@v4
                with:
                    aws-access-key-id: ${{ secrets.DEV_AWS_ACCESS_KEY_ID }}
                    aws-secret-access-key: ${{ secrets.DEV_AWS_SECRET_ACCESS_KEY }}
                    aws-region: ${{ env.AWS_REGION }}

            -   name: Login to Amazon ECR
                id: login-ecr
                uses: aws-actions/amazon-ecr-login@v2

            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v3

            -   name: Build & Push Docker Image
                env:
                    ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
                    ECR_REPOSITORY: ${{ secrets.DEV_ECR_REPOSITORY }}
                    IMAGE_TAG: ${{ github.sha }}
                run: |
                    docker buildx build \
                        --platform linux/amd64 \
                        --file infra/Dockerfile \
                        --tag $ECR_REGISTRY/$ECR_REPOSITORY:latest \
                        --tag $ECR_REGISTRY/$ECR_REPOSITORY:dev-latest \
                        --tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
                        --push \
                        .
