name: CI/CD

on:
    push:
        branches: [ develop ]
    pull_request:
        branches: [ develop ]

env:
    AWS_REGION: ap-northeast-2
    ECR_REPOSITORY: ${{ secrets.DEV_ECR_REPOSITORY }}
    CONTAINER_NAME: dev-lokit-api

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Set up JDK 24
                uses: actions/setup-java@v4
                with:
                    java-version: '24'
                    distribution: 'temurin'
                    cache: gradle

            -   name: Test (PR only)
                if: github.event_name == 'pull_request'
                run: ./gradlew test --no-daemon

            -   name: Configure AWS credentials
                if: github.event_name == 'push'
                uses: aws-actions/configure-aws-credentials@v4
                with:
                    aws-access-key-id: ${{ secrets.DEV_AWS_ACCESS_KEY_ID }}
                    aws-secret-access-key: ${{ secrets.DEV_AWS_SECRET_ACCESS_KEY }}
                    aws-region: ${{ env.AWS_REGION }}

            -   name: Login to Amazon ECR
                if: github.event_name == 'push'
                id: login-ecr
                uses: aws-actions/amazon-ecr-login@v2

            -   name: Build & Push Docker Image
                if: github.event_name == 'push'
                uses: docker/build-push-action@v6
                with:
                    context: .
                    file: infra/Dockerfile
                    push: true
                    tags: |
                        ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:dev-latest
                        ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
                    cache-from: type=gha
                    cache-to: type=gha,mode=max

            -   name: Deploy to EC2
                if: github.event_name == 'push'
                uses: appleboy/ssh-action@v1.0.3
                with:
                    host: ${{ secrets.DEV_EC2_HOST }}
                    username: ${{ secrets.DEV_EC2_USERNAME }}
                    key: ${{ secrets.DEV_EC2_SSH_KEY }}
                    script: |
                        set -e

                        docker pull ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:dev-latest

                        docker stop $CONTAINER_NAME || true
                        docker rm $CONTAINER_NAME || true

                        docker run -d \
                          --name $CONTAINER_NAME \
                          --restart unless-stopped \
                          -p 8080:8080 \
                          -e SPRING_PROFILES_ACTIVE=dev \
                          -e TZ=Asia/Seoul \
                          ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:dev-latest
