name: Dev CI/CD

on:
    push:
        branches: [ develop ]
    pull_request:
        branches: [ develop ]

concurrency:
    group: lokit-dev-${{ github.ref }}
    cancel-in-progress: true

env:
    AWS_REGION: ap-northeast-2
    ECR_REPOSITORY: ${{ secrets.DEV_ECR_REPOSITORY }}
    CONTAINER_NAME: dev-lokit-api

jobs:
    ci:
        if: github.event_name == 'pull_request'
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Set up JDK 24
                uses: actions/setup-java@v4
                with:
                    java-version: '24'
                    distribution: 'temurin'
                    cache: gradle

            -   name: Test
                run: ./gradlew test --no-daemon --parallel --build-cache

    cd:
        if: github.event_name == 'push'
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout
                uses: actions/checkout@v4

            -   name: Set up JDK 24
                uses: actions/setup-java@v4
                with:
                    java-version: '24'
                    distribution: 'temurin'
                    cache: gradle

            -   name: Configure AWS credentials
                uses: aws-actions/configure-aws-credentials@v4
                with:
                    aws-access-key-id: ${{ secrets.DEV_AWS_ACCESS_KEY_ID }}
                    aws-secret-access-key: ${{ secrets.DEV_AWS_SECRET_ACCESS_KEY }}
                    aws-region: ${{ env.AWS_REGION }}

            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v3

            -   name: Get Runner IP
                id: setup
                run: echo "runner_ip=$(curl -s https://checkip.amazonaws.com)" >> $GITHUB_OUTPUT

            -   name: Add Runner IP to Security Group
                run: |
                    aws ec2 authorize-security-group-ingress \
                        --group-id ${{ secrets.DEV_SECURITY_GROUP_ID }} \
                        --protocol tcp \
                        --port 22 \
                        --cidr ${{ steps.setup.outputs.runner_ip }}/32 \
                        --region ${{ env.AWS_REGION }} 2>/dev/null || true

            -   name: Build with Gradle
                run: ./gradlew build -x test --no-daemon --parallel --build-cache

            -   name: Login to Amazon ECR
                id: login-ecr
                uses: aws-actions/amazon-ecr-login@v2

            -   name: Build & Push Docker Image
                uses: docker/build-push-action@v6
                with:
                    context: .
                    file: infra/Dockerfile
                    push: true
                    tags: |
                        ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:dev-latest
                        ${{ steps.login-ecr.outputs.registry }}/${{ env.ECR_REPOSITORY }}:${{ github.sha }}
                    cache-from: type=gha
                    cache-to: type=gha,mode=max
                    provenance: false

            -   name: Deploy to EC2
                uses: appleboy/ssh-action@master
                env:
                    ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
                    ECR_REPOSITORY: ${{ secrets.DEV_ECR_REPOSITORY }}
                    CONTAINER_NAME: ${{ env.CONTAINER_NAME }}
                    AWS_REGION: ${{ env.AWS_REGION }}
                with:
                    host: ${{ secrets.DEV_EC2_HOST }}
                    username: ${{ secrets.DEV_EC2_USERNAME }}
                    key: ${{ secrets.DEV_EC2_SSH_KEY }}
                    envs: ECR_REGISTRY,ECR_REPOSITORY,CONTAINER_NAME,AWS_REGION
                    script: |
                        set -e

                        SSM_PREFIX="/lokit/dev"

                        aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
                        docker stop $(docker ps -qa) 2>/dev/null || true
                        docker rm -f $(docker ps -qa) 2>/dev/null || true

                        for i in {1..10}; do
                            if ! netstat -tuln 2>/dev/null | grep -q ':8080 ' && ! ss -tuln 2>/dev/null | grep -q ':8080 '; then
                                break
                            fi
                            echo "Waiting for port 8080 to be released... ($i/10)"
                            sleep 2
                        done

                        docker image prune -af --filter "until=1h"

                        docker pull $ECR_REGISTRY/$ECR_REPOSITORY:dev-latest

                        ENV_ARGS=""
                        while IFS= read -r line; do
                            key=$(echo "$line" | jq -r '.Name' | sed "s|${SSM_PREFIX}/||")
                            value=$(echo "$line" | jq -r '.Value')
                            ENV_ARGS="$ENV_ARGS -e $key=$value"
                        done < <(aws ssm get-parameters-by-path \
                            --path "$SSM_PREFIX" \
                            --with-decryption \
                            --region $AWS_REGION \
                            --query "Parameters[]" \
                            --output json | jq -c '.[]')

                        docker run -d \
                            --name $CONTAINER_NAME \
                            --restart unless-stopped \
                            -p 8080:8080 \
                            -e SPRING_PROFILES_ACTIVE=dev \
                            -e TZ=Asia/Seoul \
                            -e AWS_REGION=$AWS_REGION \
                            $ENV_ARGS \
                            --log-driver=awslogs \
                            --log-opt awslogs-region=$AWS_REGION \
                            --log-opt awslogs-group=/docker/lokit-api-dev \
                            --log-opt awslogs-stream=$CONTAINER_NAME-$(date +%Y%m%d-%H%M%S) \
                            --log-opt awslogs-create-group=true \
                            --memory="700m" \
                            --memory-swap="1400m" \
                            --cpus="1.5" \
                            $ECR_REGISTRY/$ECR_REPOSITORY:dev-latest

                        docker ps --filter "name=$CONTAINER_NAME" --format "{{.Status}}"

            -   name: Remove Runner IP from Security Group
                if: always()
                run: |
                    aws ec2 revoke-security-group-ingress \
                        --group-id ${{ secrets.DEV_SECURITY_GROUP_ID }} \
                        --protocol tcp \
                        --port 22 \
                        --cidr ${{ steps.setup.outputs.runner_ip }}/32 \
                        --region ${{ env.AWS_REGION }} 2>/dev/null || true
